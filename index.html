<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Reading Coach: Emperor Penguins (Survival Mode)</title>
    <!-- FontAwesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fdcb6e;
            --bg-color: #dfe6e9;
            --panel-bg: #ffffff;
            --text-color: #2d3436;
            --highlight: #ffeaa7;
            --game-bg-gradient: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            --danger: #ff7675;
            --safe: #55efc4;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            margin: 0; padding: 0;
            display: flex; height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.6s ease-out;
            color: white; text-align: center;
        }
        .splash-icon { font-size: 5rem; margin-bottom: 20px; animation: bounce 2s infinite; }
        .splash-title { font-size: 3rem; font-weight: 800; margin-bottom: 10px; }
        .splash-desc { font-size: 1.2rem; margin-bottom: 30px; opacity: 0.9; }
        
        #start-btn {
            padding: 15px 50px; font-size: 1.3rem; border: none; border-radius: 50px;
            background: white; color: var(--primary); font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.05); }

        /* --- LEFT PANEL: READING --- */
        #reading-panel {
            width: 45%; padding: 40px; background-color: var(--panel-bg);
            border-right: 1px solid #b2bec3; overflow-y: auto;
            display: flex; flex-direction: column;
            position: relative;
        }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f2f6; padding-bottom: 15px; }
        h2 { margin: 0; color: var(--primary); font-size: 1.8rem; }
        
        .toggle-btn {
            background: white; border: 2px solid var(--primary); color: var(--primary);
            padding: 5px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.9rem;
        }
        .toggle-btn:hover { background: #f1f2f6; }

        .passage-content { font-size: 1.2rem; line-height: 2.0; color: #444; text-align: justify; }
        
        /* Highlight Animation */
        .sent { border-radius: 4px; padding: 2px 0; transition: background-color 0.5s ease; cursor: pointer; }
        .sent:hover { background-color: #f1f2f6; }
        .sent.highlight {
            background-color: var(--highlight);
            box-shadow: 0 0 8px rgba(253, 203, 110, 0.6);
            font-weight: 700; border-bottom: 2px solid var(--accent);
        }

        #korean-trans {
            display: none; margin-top: 30px; padding: 20px;
            background: #f8f9fa; border-radius: 10px; border-left: 4px solid var(--primary);
            font-size: 1rem; color: #636e72; line-height: 1.6;
        }

        /* --- RIGHT PANEL: INTERACTION --- */
        #interaction-panel {
            width: 55%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--game-bg-gradient); color: white; position: relative;
        }

        /* Top Controls (Classroom Mode) */
        #top-controls {
            position: absolute; top: 20px; right: 20px; z-index: 100;
        }
        .class-mode-switch {
            background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 30px;
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.3); transition: 0.3s;
        }
        .class-mode-switch:hover { background: rgba(255,255,255,0.25); }
        .class-mode-switch.active { background: var(--safe); color: #2d3436; border-color: var(--safe); }

        /* HUD */
        #game-hud {
            width: 90%; display: flex; justify-content: space-between; margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1); padding: 12px 25px; border-radius: 15px;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
        }
        .hud-item { font-size: 1.1rem; font-weight: bold; }
        .hud-value { color: var(--accent); margin-left: 5px; }

        /* Avatar */
        #ai-visual-container { position: relative; width: 140px; height: 140px; margin-bottom: 20px; }
        #ai-avatar {
            width: 100%; height: 100%; background: #34495e; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 120px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: all 0.3s;
            border: 4px solid rgba(255,255,255,0.1);
        }
        #ai-avatar.speaking { border-color: var(--accent); animation: pulse 1.2s infinite; }
        #ai-avatar.danger { border-color: var(--danger); animation: shake 0.5s; }
        #ai-avatar.safe { border-color: var(--safe); box-shadow: 0 0 30px var(--safe); }
        #ai-avatar.winner { background: var(--accent); color: #2d3436; animation: bounce 1s infinite; }
        #ai-avatar.thinking { border-color: #dfe6e9; animation: pulse 2s infinite; opacity: 0.8; }
        
        /* Hatching Animation */
        #ai-avatar.hatching {
            background-color: #ffeaa7;
            animation: hatch 1s ease-out forwards;
        }
        @keyframes hatch {
            0% { transform: scale(0.8) rotate(0deg); opacity: 0.5; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* Chat Bubble */
        .bubble-box {
            width: 85%; max-width: 600px; background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; padding: 25px; margin-bottom: 20px; color: #2d3436;
            min-height: 140px; position: relative; text-align: center;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #ai-text { font-size: 1.2rem; font-weight: 600; line-height: 1.5; white-space: pre-line; margin-bottom: 0; }
        
        /* Input Area (Hybrid) */
        #input-wrapper {
            width: 80%; display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        
        #text-input-row {
            width: 100%; display: none; /* Hidden by default */
            flex-direction: row; gap: 10px; animation: slideUp 0.3s ease-out;
        }
        #user-input-text {
            flex: 1; padding: 15px; border-radius: 25px; border: none; outline: none;
            font-size: 1.1rem; background: rgba(255,255,255,0.9); box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #send-text-btn {
            width: 50px; height: 50px; background: var(--safe); border: none; border-radius: 50%;
            cursor: pointer; color: #2d3436; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        #send-text-btn:hover { transform: scale(1.1); }
        #send-text-btn:disabled { background: #b2bec3; cursor: not-allowed; }

        .controls-row { display: flex; align-items: center; gap: 20px; justify-content: center; }
        
        #mic-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: var(--primary); color: white; border: none; font-size: 28px;
            cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.3); transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        #mic-btn.active { background: #ff7675; animation: pulse 1.5s infinite; }
        #mic-btn:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; }

        .mode-toggle-btn {
            width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2);
            color: white; border: none; font-size: 20px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .mode-toggle-btn:hover { background: rgba(255,255,255,0.4); }
        .mode-toggle-btn.active { background: white; color: var(--primary); }

        .status-text { margin-top: 15px; color: #b2bec3; font-size: 0.9rem; min-height: 20px; }

        /* Animations */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Utilities */
        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #reading-panel { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid #ccc; padding: 20px; }
            #interaction-panel { width: 100%; height: 60%; }
            h2 { font-size: 1.4rem; }
            .passage-content { font-size: 1rem; line-height: 1.6; }
            #ai-avatar { width: 100px; height: 100px; font-size: 50px; }
            #mic-btn { width: 60px; height: 60px; font-size: 24px; }
        }
    </style>
</head>
<body>

    <!-- INTRO SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="splash-icon">ğŸ§</div>
        <div class="splash-title">Emperor Penguin<br>Survival Challenge</div>
        <div class="splash-desc">í™©ì œí­ê·„ ì•„ë¹ ê°€ ë˜ì–´, ì•Œì„ ì¶”ìœ„ë¡œë¶€í„° ì§€ì¼œì£¼ì„¸ìš”.</div>
        <button id="start-btn">Start Adventure</button>
    </div>

    <!-- LEFT: READING PANEL -->
    <div id="reading-panel">
        <div class="header-row">
            <h2>Emperor Penguins</h2>
            <button class="toggle-btn" id="trans-btn">í•œê¸€ í•´ì„</button>
        </div>

        <div class="passage-content">
            <span id="s1" class="sent">Emperor penguins are the worldâ€™s largest penguins.</span>
            <span id="s2" class="sent">Adult emperor penguins can stand over 1 meter tall.</span>
            <span id="s3" class="sent">But to grow this tall from an egg, Emperor Penguins need a lot of dedicated work from their parents.</span>
            <br><br>
            <span id="s4" class="sent">Every winter, each mother penguin lays just one egg.</span>
            <span id="s5" class="sent">The mother passes the egg to the father.</span>
            <span id="s6" class="sent">Then she goes on a long journey to the ocean to find food.</span>
            <span id="s7" class="sent">The father puts the egg on his feet.</span>
            <span id="s8" class="sent">He covers it with a special skin fold.</span>
            <span id="s9" class="sent">This is called a brood pouch.</span>
            <span id="s10" class="sent">He has to be very careful.</span>
            <span id="s11" class="sent">The egg will freeze within minutes if it touches the icy ground.</span>
            <br><br>
            <span id="s12" class="sent">The father stands still in the freezing cold for two months until the egg hatches.</span>
            <span id="s13" class="sent">The egg is kept warm in the brood pouch at about 38 Â°C.</span>
            <span id="s14" class="sent">Outside temperatures in Antarctica can drop below âˆ’35 Â°C.</span>
            <span id="s15" class="sent">To endure the cold, fathers form a tight "huddle" and share their body heat.</span>
            <span id="s16" class="sent">During this time, the father doesnâ€™t eat anything.</span>
            <span id="s17" class="sent">He uses his body fat to survive.</span>
            <br><br>
            <span id="s18" class="sent">Finally, the egg hatches.</span>
            <span id="s19" class="sent">The mother returns with food for the chick.</span>
            <span id="s20" class="sent">The chick is very small.</span>
            <span id="s21" class="sent">It weighs only about 150 g to 200 g.</span>
            <span id="s22" class="sent">The parents take turns feeding and caring for their chick until itâ€™s big enough to be independent.</span>
        </div>

        <div id="korean-trans">
            <strong>[ì „ì²´ í•´ì„]</strong><br><br>
            í™©ì œí­ê·„ì€ ì„¸ê³„ì—ì„œ ê°€ì¥ í° í­ê·„ì…ë‹ˆë‹¤. ë‹¤ ìë€ í™©ì œí­ê·„ì€ í‚¤ê°€ 1ë¯¸í„°ê°€ ë„˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì•Œì—ì„œ ì´ë ‡ê²Œ í¬ê²Œ ìë¼ê¸° ìœ„í•´ì„œ, í™©ì œí­ê·„ì€ ë¶€ëª¨ì˜ ë§ì€ í—Œì‹ ì ì¸ ë…¸ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.<br><br>
            ë§¤ë…„ ê²¨ìš¸, ì—„ë§ˆ í­ê·„ì€ ë”± í•˜ë‚˜ì˜ ì•Œì„ ë‚³ìŠµë‹ˆë‹¤. ì—„ë§ˆëŠ” ì•Œì„ ì•„ë¹ ì—ê²Œ ê±´ë„¤ì¤ë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¨¹ì´ë¥¼ ì°¾ìœ¼ëŸ¬ ë°”ë‹¤ë¡œ ê¸´ ì—¬í–‰ì„ ë– ë‚©ë‹ˆë‹¤. ì•„ë¹ ëŠ” ì•Œì„ ë°œ ìœ„ì— ì˜¬ë ¤ë†“ìŠµë‹ˆë‹¤. ê·¸ëŠ” íŠ¹ë³„í•œ í”¼ë¶€ ì£¼ë¦„ìœ¼ë¡œ ì•Œì„ ë®ìŠµë‹ˆë‹¤. ì´ê²ƒì„ 'ìœ¡ì•„ë‚­(brood pouch)'ì´ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤. ì•„ë¹ ëŠ” ë§¤ìš° ì¡°ì‹¬í•´ì•¼ í•©ë‹ˆë‹¤. ì•Œì´ ì–¼ìŒ ë•…ì— ë‹¿ìœ¼ë©´ ëª‡ ë¶„ ì•ˆì— ì–¼ì–´ë²„ë¦´ ê²ƒì…ë‹ˆë‹¤.<br><br>
            ì•„ë¹ ëŠ” ì•Œì´ ë¶€í™”í•  ë•Œê¹Œì§€ ë‘ ë‹¬ ë™ì•ˆ ì–¼ì–´ë¶™ì„ ë“¯í•œ ì¶”ìœ„ ì†ì—ì„œ ê°€ë§Œíˆ ì„œ ìˆìŠµë‹ˆë‹¤. ì•Œì€ ìœ¡ì•„ë‚­ ì•ˆì—ì„œ ì•½ 38ë„(Â°C)ë¡œ ë”°ëœ»í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤. ë‚¨ê·¹ì˜ ì™¸ë¶€ ì˜¨ë„ëŠ” ì˜í•˜ 35ë„(âˆ’35 Â°C) ì•„ë˜ë¡œ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¶”ìœ„ë¥¼ ê²¬ë””ê¸° ìœ„í•´, ì•„ë¹ ë“¤ì€ ê½‰ ë­‰ì³ì„œ "í—ˆë“¤(huddle)"ì„ ë§Œë“¤ê³  ì²´ì˜¨ì„ ë‚˜ëˆ•ë‹ˆë‹¤. ì´ ê¸°ê°„ ë™ì•ˆ, ì•„ë¹ ëŠ” ì•„ë¬´ê²ƒë„ ë¨¹ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ëŠ” ì‚´ì•„ë‚¨ê¸° ìœ„í•´ ì²´ì§€ë°©ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.<br><br>
            ë§ˆì¹¨ë‚´, ì•Œì´ ë¶€í™”í•©ë‹ˆë‹¤. ì—„ë§ˆëŠ” ìƒˆë¼ë¥¼ ìœ„í•œ ë¨¹ì´ë¥¼ ê°€ì§€ê³  ëŒì•„ì˜µë‹ˆë‹¤. ìƒˆë¼ëŠ” ë§¤ìš° ì‘ìŠµë‹ˆë‹¤. ë¬´ê²ŒëŠ” ê²¨ìš° 150gì—ì„œ 200g ì •ë„ì…ë‹ˆë‹¤. ë¶€ëª¨ëŠ” ìƒˆë¼ê°€ ë…ë¦½í•  ìˆ˜ ìˆì„ ë§Œí¼ í´ ë•Œê¹Œì§€ ë²ˆê°ˆì•„ ê°€ë©° ë¨¹ì´ë¥¼ ì£¼ê³  ëŒë´…ë‹ˆë‹¤.
        </div>
    </div>

    <!-- RIGHT: INTERACTION PANEL -->
    <div id="interaction-panel">
        
        <!-- Classroom Mode Toggle -->
        <div id="top-controls">
            <div class="class-mode-switch" id="class-mode-toggle" onclick="toggleMode()">
                <i class="fas fa-volume-up" id="cls-icon"></i> <span id="cls-text">Sound ON</span>
            </div>
        </div>

        <div id="game-hud">
            <div class="hud-item"><i class="fas fa-map-marker-alt"></i> Stage: <span id="stage-val" class="hud-value">Intro</span></div>
            <div class="hud-item"><i class="fas fa-egg"></i> Status: <span id="egg-val" class="hud-value">Safe</span></div>
        </div>

        <div id="ai-visual-container">
            <div id="ai-avatar"><i class="fas fa-egg"></i></div>
        </div>

        <div class="bubble-box">
            <div id="ai-text">...</div>
        </div>

        <!-- Hybrid Input Wrapper -->
        <div id="input-wrapper">
            <!-- Text Input (Appears on Toggle or after Speech) -->
            <div id="text-input-row">
                <input type="text" id="user-input-text" placeholder="Type your answer here..." onkeypress="handleKey(event)">
                <button id="send-text-btn" onclick="handleInputSubmission()"><i class="fas fa-paper-plane"></i></button>
            </div>

            <!-- Controls -->
            <div class="controls-row">
                <button class="mode-toggle-btn" id="keyboard-btn" onclick="toggleKeyboardInput()" title="Type Answer">
                    <i class="fas fa-keyboard"></i>
                </button>
                <button id="mic-btn" onclick="toggleMic()" title="Speak Answer">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
            
            <div class="status-text" id="status-text">Click Mic to speak or Keyboard to type</div>
        </div>
    </div>

    <script>
        // --- 1. Game State & Logic ---
        let currentStage = 0;
        let currentAttempts = 0; // Track wrong attempts per stage
        let isClassroomMode = false;
        let isRecogActive = false;
        let recognition;

        // Game Flow & Scaffolding Data
        const scenarios = [
            {
                id: 0,
                prompt: "You are a Father Penguin. The mother passes you the precious egg. Do you put it on the ICE or on your FEET?",
                correctKeywords: ["feet", "foot", "legs", "pouch"],
                wrongKeywords: ["ice", "ground", "floor", "snow"],
                evidenceId: "s11",
                hint1: "No! Check the highlight. The text says the egg freezes on the ice.  Where does the father put the egg?",
                hint2: "The ice is too cold. Which part of your body can hold the egg off the ground?",
                context: "Egg freezes on ice within minutes. Must be on feet."
            },
            {
                id: 1,
                prompt: "Phew, the egg is safe on your feet. But a blizzard is coming! It's freezing. Do you stand ALONE or join the HUDDLE?",
                correctKeywords: ["huddle", "group", "together", "join"],
                wrongKeywords: ["alone", "stand", "solo", "stay"],
                evidenceId: "s15",
                hint1: "No! Standing alone is too cold. Check the highlight. What do fathers form to share heat?",
                hint2: "Standing alone is freezing. What does the text say fathers form to share heat?",
                context: "Fathers form a huddle to share body heat."
            },
            {
                id: 2,
                prompt: "You are warm in the huddle. But it has been 2 months. You are starving! Do you LEAVE to find fish or WAIT?",
                correctKeywords: ["wait", "stay", "nothing", "fat", "body fat", "survive"],
                wrongKeywords: ["leave", "fish", "eat", "food", "go"],
                evidenceId: "s16",
                hint1: "Wait! Check the highlighted sentence. The text says the father doesn't eat. Instead of leaving, what must you do?",
                hint2: "He doesn't eat. If you leave, the egg freezes. So, must you leave or wait?",
                context: "Father doesn't eat. Uses body fat. Leaving kills the egg."
            }
        ];

        // --- 2. DOM Elements ---
        const ui = {
            splash: document.getElementById('splash-screen'),
            startBtn: document.getElementById('start-btn'),
            aiText: document.getElementById('ai-text'),
            avatar: document.getElementById('ai-avatar'),
            stageVal: document.getElementById('stage-val'),
            eggVal: document.getElementById('egg-val'),
            micBtn: document.getElementById('mic-btn'),
            textInputRow: document.getElementById('text-input-row'),
            textInput: document.getElementById('user-input-text'),
            keyboardBtn: document.getElementById('keyboard-btn'),
            sendBtn: document.getElementById('send-text-btn'),
            statusText: document.getElementById('status-text'),
            transBtn: document.getElementById('trans-btn'),
            koreanTrans: document.getElementById('korean-trans'),
            clsToggle: document.getElementById('class-mode-toggle'),
            clsIcon: document.getElementById('cls-icon'),
            clsText: document.getElementById('cls-text')
        };

        // --- 3. Event Listeners ---
        ui.startBtn.addEventListener('click', () => {
            ui.splash.style.opacity = '0';
            setTimeout(() => {
                ui.splash.style.display = 'none';
                initGame();
            }, 600);
        });

        ui.transBtn.addEventListener('click', () => {
            const isHidden = ui.koreanTrans.style.display !== 'block';
            ui.koreanTrans.style.display = isHidden ? 'block' : 'none';
            ui.transBtn.textContent = isHidden ? 'í•´ì„ ìˆ¨ê¸°ê¸°' : 'í•œê¸€ í•´ì„';
        });

        function toggleMode() {
            isClassroomMode = !isClassroomMode;
            if (isClassroomMode) {
                ui.clsToggle.classList.add('active');
                ui.clsIcon.className = "fas fa-volume-mute";
                ui.clsText.textContent = "Silent Mode";
                ui.statusText.textContent = "Classroom Mode: Audio Muted";
                window.speechSynthesis.cancel();
            } else {
                ui.clsToggle.classList.remove('active');
                ui.clsIcon.className = "fas fa-volume-up";
                ui.clsText.textContent = "Sound ON";
                ui.statusText.textContent = "Click Mic to speak";
            }
        }

        // --- 4. Game Logic ---
        function initGame() {
            currentStage = 0;
            currentAttempts = 0;
            updateUIForStage();
            initSpeech();
        }

        function updateUIForStage() {
            const scenario = scenarios[currentStage];
            
            // Text Update
            typeWriter(scenario.prompt, ui.aiText);
            speak(scenario.prompt.replace(/\*/g, '')); 
            
            // HUD
            ui.stageVal.textContent = (currentStage + 1) + "/3";
            ui.avatar.className = ""; 
        }

        function handleInputSubmission() {
            const text = ui.textInput.value.trim();
            if(!text) return;
            
            processUserResponse(text);
        }

        async function processUserResponse(userInput) {
            const scenario = scenarios[currentStage];
            
            ui.aiText.textContent = "Thinking...";
            ui.avatar.classList.add('thinking');
            ui.micBtn.disabled = true;
            ui.sendBtn.disabled = true;

            // 1. Check Correctness
            let isCorrect = scenario.correctKeywords.some(kw => userInput.toLowerCase().includes(kw));
            
            // 2. Feedback Generation
            let feedbackText = "";
            let status = isCorrect ? "correct" : "wrong";

            if (isCorrect) {
                currentAttempts = 0; // Reset for next stage
                feedbackText = await getAIFeedback(userInput, "correct", scenario, 0);
            } else {
                currentAttempts++;
                // Select hint based on attempts
                if (currentAttempts === 1) {
                    feedbackText = scenario.hint1; // Scaffolding Level 1
                } else {
                    feedbackText = scenario.hint2; // Scaffolding Level 2
                }
            }

            ui.avatar.classList.remove('thinking');
            ui.micBtn.disabled = false;
            ui.sendBtn.disabled = false;

            // Clear input here (when AI responds)
            ui.textInput.value = "";

            // 3. Display & Speak Feedback
            ui.aiText.textContent = feedbackText;
            speak(feedbackText);

            // 4. Update Game State
            if (isCorrect) {
                ui.avatar.classList.add('safe');
                ui.eggVal.textContent = "Safe";
                ui.eggVal.style.color = "var(--safe)";
                
                // End Game Check
                if (currentStage === scenarios.length - 1) {
                     setTimeout(() => {
                        triggerEnding();
                    }, 4000);
                } else {
                    setTimeout(() => {
                        currentStage++;
                        currentAttempts = 0;
                        updateUIForStage();
                    }, 4000); 
                }
            } else {
                // Wrong / Penalty
                triggerPenalty(scenario);
            }
        }

        function triggerEnding() {
            const endMsg = "Crack! The egg hatches! The chick is born.";
            ui.aiText.textContent = endMsg;
            speak(endMsg);
            
            ui.avatar.classList.add('hatching');
            ui.avatar.innerHTML = "ğŸ£"; 
            ui.eggVal.textContent = "HATCHED!";
            ui.statusText.textContent = "Mission Accomplished!";
            ui.micBtn.disabled = true;
            ui.sendBtn.disabled = true;
        }

        // --- 5. AI Generation (OpenAI via Backend) ---
        async function getAIFeedback(userInput, status, scenario, attempts) {
            try {
                // Call Netlify Function (OpenAI Proxy)
                // Note: The file name is openai_proxy.js in the backend
                const response = await fetch('/.netlify/functions/openai_proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userInput,
                        status,
                        context: scenario.context,
                        attempts
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                let reply = data.text || "Error generating response.";
                return reply.replace(/\*/g, '');

            } catch (e) {
                console.error("Backend AI Call Failed:", e);
                return simulateAIResponse(userInput, status, scenario);
            }
        }

        function simulateAIResponse(input, status, scenario) {
            if (status === "correct") return "That's correct! " + (scenario.context.split('.')[0] || "Great job.");
            return "Try again."; 
        }

        // --- 6. Penalty System (Simplified) ---
        function triggerPenalty(scenario) {
            ui.avatar.classList.add('danger');
            ui.eggVal.textContent = "DANGER!";
            ui.eggVal.style.color = "var(--danger)";

            // Highlight Evidence
            document.querySelectorAll('.sent').forEach(el => el.classList.remove('highlight'));
            const evidence = document.getElementById(scenario.evidenceId);
            if (evidence) {
                evidence.classList.add('highlight');
                evidence.scrollIntoView({ behavior: "smooth", block: "center" });
            }
            
            // Allow immediate retry
            setTimeout(() => {
                ui.avatar.classList.remove('danger');
            }, 2000);
        }

        // --- 7. Hybrid Input (Mic + Text) ---
        function toggleKeyboardInput() {
            const isVisible = ui.textInputRow.style.display === 'flex';
            ui.textInputRow.style.display = isVisible ? 'none' : 'flex';
            ui.keyboardBtn.classList.toggle('active', !isVisible);
            if (!isVisible) ui.textInput.focus();
        }

        function handleKey(e) {
            if(e.key === 'Enter') handleInputSubmission();
        }

        function initSpeech() {
            if (!('webkitSpeechRecognition' in window)) {
                ui.statusText.textContent = "Speech API not supported in this browser. Use Text.";
                ui.micBtn.style.display = 'none';
                ui.textInputRow.style.display = 'flex'; 
                return;
            }
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = true; 

            recognition.onstart = () => {
                isRecogActive = true;
                ui.micBtn.classList.add('active');
                ui.statusText.textContent = "Listening...";
                ui.textInputRow.style.display = 'flex';
                ui.textInput.value = "";
            };

            recognition.onend = () => {
                isRecogActive = false;
                ui.micBtn.classList.remove('active');
                ui.statusText.textContent = "Sending...";
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                        ui.textInput.value = finalTranscript;
                        handleInputSubmission(); 
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                        ui.textInput.value = interimTranscript; 
                    }
                }
            };
        }

        function toggleMic() {
            if (isRecogActive) recognition.stop();
            else recognition.start();
        }

        // --- 8. TTS (Browser - Nova Style Optimization) ---
        function speak(text) {
            if (isClassroomMode) return;
            window.speechSynthesis.cancel(); 
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'en-US';
            ut.rate = 0.9; 
            ut.pitch = 1.0; 
            
            const voices = window.speechSynthesis.getVoices();
            const femaleVoice = voices.find(v => v.name.includes('Google US English')) || 
                                voices.find(v => v.name.includes('Zira')) ||
                                voices.find(v => v.name.includes('Samantha')) ||
                                voices.find(v => v.name.toLowerCase().includes('female'));
            
            if (femaleVoice) ut.voice = femaleVoice;

            window.speechSynthesis.speak(ut);
            ui.avatar.classList.add('speaking');
            ut.onend = () => ui.avatar.classList.remove('speaking');
        }

        window.speechSynthesis.onvoiceschanged = () => {
            // Voices loaded
        };

        function typeWriter(text, el) {
            el.innerHTML = "";
            let i = 0;
            const speed = 30;
            function type() {
                if (i < text.length) {
                    if(text.substring(i, i+4) === "<br>") {
                        el.innerHTML += "<br>";
                        i += 4;
                    } else if (text.charAt(i) === "*") {
                         i++;
                    } else {
                        el.innerHTML += text.charAt(i);
                        i++;
                    }
                    setTimeout(type, speed);
                } else {
                    el.innerHTML = el.innerHTML.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                }
            }
            type();
        }
    </script>
</body>
</html>
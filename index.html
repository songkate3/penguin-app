<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Reading Coach: Emperor Penguins</title>
    <!-- FontAwesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fdcb6e;
            --bg-color: #dfe6e9;
            --panel-bg: #ffffff;
            --text-color: #2d3436;
            --highlight: #ffeaa7;
            --game-btn: #00cec9;
            --game-bg: #2c3e50; /* ë‚¨ê·¹ ë°¤ ë°°ê²½ */
            --danger: #ff7675;
            --safe: #55efc4;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- SPLASH SCREEN (INTRO) --- */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.6s ease-out;
        }
        
        .splash-content {
            text-align: center;
            color: white;
            animation: zoomIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .splash-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 4px 15px rgba(0,0,0,0.2);
            letter-spacing: -1px;
        }

        .splash-subtitle {
            font-size: 1.5rem;
            opacity: 0.9;
            margin-bottom: 40px;
            font-weight: 300;
        }

        .splash-icon {
            font-size: 6rem;
            margin-bottom: 30px;
            display: inline-block;
            animation: bounce 2s infinite;
        }

        #enter-btn {
            padding: 15px 50px;
            font-size: 1.3rem;
            border: none;
            border-radius: 50px;
            background: white;
            color: var(--primary);
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #enter-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* --- LEFT PANEL: READING PASSAGE --- */
        #reading-panel {
            width: 45%;
            padding: 40px;
            background-color: var(--panel-bg);
            border-right: 1px solid #b2bec3;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f2f6;
        }

        h2 { margin: 0; color: var(--primary); font-size: 1.8rem; }

        .toggle-btn {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: 0.3s;
        }
        .toggle-btn:hover { background: #f1f2f6; }
        .toggle-btn.active { background: var(--primary); color: white; }

        .passage-content {
            font-size: 1.2rem;
            line-height: 1.9;
            color: #444;
            text-align: justify;
        }

        /* Highlight Animation */
        .sent {
            border-radius: 4px;
            padding: 2px 0;
            transition: background-color 0.5s ease;
        }
        .sent.highlight {
            background-color: var(--highlight);
            box-shadow: 0 0 8px rgba(253, 203, 110, 0.6);
            font-weight: 700;
            border-bottom: 2px solid var(--accent);
        }

        #korean-trans {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 1rem;
            color: #636e72;
            line-height: 1.6;
            border-left: 4px solid var(--primary);
        }

        /* --- RIGHT PANEL: AI INTERACTION --- */
        #interaction-panel {
            width: 55%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5f6fa 0%, #dcdde1 100%);
            position: relative;
            transition: background 0.5s;
        }

        /* Game Mode Theme */
        #interaction-panel.game-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            color: white;
        }

        /* Game HUD */
        #game-hud {
            display: none;
            width: 90%;
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideDown 0.5s;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .hud-item { font-size: 1.1rem; font-weight: bold; color: #fab1a0; }
        .hud-value { color: white; margin-left: 5px; }

        /* API Setup Bar - Simplified */
        #setup-bar {
            position: absolute;
            top: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 25px;
            border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            z-index: 100;
            transition: opacity 0.5s;
        }
        /* Input field removed */
        #ready-btn { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
            transition: all 0.2s;
        }
        #ready-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(108, 92, 231, 0.4); }

        /* AI Interface Container (Hidden initially) */
        #ai-interface {
            display: none; /* Hidden until login */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        /* AI Avatar & Visuals */
        #ai-visual-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin-bottom: 20px;
        }

        #ai-avatar {
            width: 100%; height: 100%;
            background: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 100px; /* Bigger Egg */
            box-shadow: 0 10px 30px rgba(108, 92, 231, 0.2);
            transition: all 0.3s;
            position: relative;
            z-index: 2;
        }
        
        /* Specific Styles for Survival Mode */
        #ai-avatar.survival-mode {
            background: #34495e;
            color: white;
        }
        
        /* Animations */
        #ai-avatar.survival-mode.danger {
            color: var(--danger);
            animation: eggCrack 0.5s ease-in-out;
        }
        
        #ai-avatar.survival-mode.safe {
            color: var(--safe);
            box-shadow: 0 0 40px var(--safe);
            animation: eggGlow 1.5s infinite alternate;
        }

        /* Hatching Penguin Animation */
        #ai-avatar.survival-mode.hatching {
            border: 5px solid var(--safe);
            background-color: #e3fdf5;
            color: #2d3436;
            animation: hatchPop 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        @keyframes eggCrack {
            0% { transform: rotate(0deg) translateX(0); }
            20% { transform: rotate(-10deg) translateX(-5px); }
            40% { transform: rotate(10deg) translateX(5px); }
            60% { transform: rotate(-10deg) translateX(-5px); }
            80% { transform: rotate(10deg) translateX(5px); }
            100% { transform: rotate(0deg) translateX(0); }
        }
        
        @keyframes eggGlow {
            from { box-shadow: 0 0 10px var(--safe); transform: scale(1); }
            to { box-shadow: 0 0 40px var(--safe); transform: scale(1.05); }
        }

        @keyframes hatchPop {
            0% { transform: scale(0.8) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* Status Rings */
        .ring {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%;
            border: 3px solid transparent;
            z-index: 1;
        }
        
        #ai-avatar.speaking + .ring {
            border-color: var(--accent);
            animation: pulse-ring 1.5s infinite;
        }
        #ai-avatar.thinking {
            border: 3px solid #b2bec3;
            animation: pulse-gray 1.5s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        @keyframes pulse-gray {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.5; }
        }

        /* Bubble */
        .bubble-box {
            width: 85%; max-width: 600px;
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            min-height: 120px;
            display: flex; flex-direction: column; justify-content: center;
            text-align: center;
            position: relative;
            margin-bottom: 20px;
        }
        
        /* Game Mode Bubble */
        .game-mode .bubble-box {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--game-btn);
        }

        #ai-text { 
            font-size: 1.35rem; 
            color: #2d3436; 
            font-weight: 600; 
            line-height: 1.4; 
            margin-bottom: 10px;
            white-space: pre-line; 
        }
        
        #ai-kor-hint {
            font-size: 1.1rem; color: #636e72;
            display: none; /* Hidden by default */
            border-top: 1px dashed #dfe6e9;
            padding-top: 15px; margin-top: 10px;
        }

        .hint-toggle-small {
            position: absolute; bottom: 10px; right: 20px;
            font-size: 0.8rem; color: #b2bec3;
            background: none; border: none; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }
        .hint-toggle-small:hover { color: var(--primary); }

        /* User Mic Area */
        #user-stt-display {
            height: 30px; width: 80%;
            text-align: center; color: var(--primary);
            font-weight: bold; font-size: 1.1rem;
            margin-bottom: 20px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        .game-mode #user-stt-display { color: #fab1a0; }

        #mic-btn {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: var(--primary); color: white;
            border: none; font-size: 30px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        #mic-btn:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; }
        #mic-btn.active { background: #ff7675; animation: bounce 1s infinite; }

        /* NEXT BUTTON */
        #next-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            background: var(--safe);
            color: #2d3436;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(85, 239, 196, 0.4);
            animation: bounce 2s infinite;
        }

        @keyframes bounce { 0%, 100% {transform: scale(1);} 50% {transform: scale(1.1);} }

        .status-text { margin-top: 15px; color: #636e72; font-size: 0.9rem; }
        .game-mode .status-text { color: #bdc3c7; }
        
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; height: 100vh; }
            #reading-panel { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid #ccc; padding: 20px; }
            #interaction-panel { width: 100%; height: 60%; }
            h2 { font-size: 1.5rem; }
            .passage-content { font-size: 1rem; line-height: 1.6; }
            #ai-text { font-size: 1.1rem; }
            #mic-btn { width: 60px; height: 60px; font-size: 24px; }
            #ai-visual-container { width: 100px; height: 100px; margin-bottom: 15px; }
            #ai-avatar { font-size: 40px; }
        }
    </style>
</head>
<body>

    <!-- INTRO SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-icon">ğŸ§</div>
            <div class="splash-title">AI post-reading activity</div>
            <div class="splash-subtitle">Emperor Penguin Survival Challenge</div>
            <button id="enter-btn">Let's Start!</button>
        </div>
    </div>

    <!-- LEFT: PASSAGE -->
    <div id="reading-panel">
        <div class="header-row">
            <h2>Emperor Penguins</h2>
            <button id="toggle-kor-btn" class="toggle-btn">í•œê¸€ í•´ì„ ë³´ê¸°</button>
        </div>

        <div class="passage-content">
            <span id="s1" class="sent">Emperor penguins are the worldâ€™s largest penguins.</span>
            <span id="s2" class="sent">Adult emperor penguins can stand over 1 meter tall.</span>
            <span id="s3" class="sent">But to grow this tall from an egg, Emperor Penguins need a lot of dedicated work from their parents.</span>
            <br><br>
            <span id="s4" class="sent">Every winter, each mother penguin lays just one egg.</span>
            <span id="s5" class="sent">The mother passes the egg to the father.</span>
            <span id="s6" class="sent">Then she goes on a long journey to the ocean to find food.</span>
            <span id="s7" class="sent">The father puts the egg on his feet.</span>
            <span id="s8" class="sent">He covers it with a special skin fold.</span>
            <span id="s9" class="sent">This is called a brood pouch.</span>
            <span id="s10" class="sent">He has to be very careful.</span>
            <span id="s11" class="sent">The egg will freeze within minutes if it touches the icy ground.</span>
            <br><br>
            <span id="s12" class="sent">The father stands still in the freezing cold for two months until the egg hatches.</span>
            <span id="s13" class="sent">The egg is kept warm in the brood pouch at about 38 Â°C.</span>
            <span id="s14" class="sent">Outside temperatures in Antarctica can drop below âˆ’35 Â°C.</span>
            <span id="s15" class="sent">To endure the cold, fathers form a tight "huddle" and share their body heat.</span>
            <span id="s16" class="sent">During this time, the father doesnâ€™t eat anything.</span>
            <span id="s17" class="sent">He uses his body fat to survive.</span>
            <br><br>
            <span id="s18" class="sent">Finally, the egg hatches.</span>
            <span id="s19" class="sent">The mother returns with food for the chick.</span>
            <span id="s20" class="sent">The chick is very small.</span>
            <span id="s21" class="sent">It weighs only about 150 g to 200 g.</span>
            <span id="s22" class="sent">The parents take turns feeding and caring for their chick until itâ€™s big enough to be independent.</span>
        </div>

        <div id="korean-trans">
            <strong>[ì „ì²´ í•´ì„]</strong><br><br>
            í™©ì œí­ê·„ì€ ì„¸ê³„ì—ì„œ ê°€ì¥ í° í­ê·„ì…ë‹ˆë‹¤. ë‹¤ ìë€ í™©ì œí­ê·„ì€ í‚¤ê°€ 1ë¯¸í„°ê°€ ë„˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì•Œì—ì„œ ì´ë ‡ê²Œ í¬ê²Œ ìë¼ê¸° ìœ„í•´ì„œ, í™©ì œí­ê·„ì€ ë¶€ëª¨ì˜ ë§ì€ í—Œì‹ ì ì¸ ë…¸ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.<br><br>
            ë§¤ë…„ ê²¨ìš¸, ì—„ë§ˆ í­ê·„ì€ ë”± í•˜ë‚˜ì˜ ì•Œì„ ë‚³ìŠµë‹ˆë‹¤. ì—„ë§ˆëŠ” ì•Œì„ ì•„ë¹ ì—ê²Œ ê±´ë„¤ì¤ë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¨¹ì´ë¥¼ ì°¾ìœ¼ëŸ¬ ë°”ë‹¤ë¡œ ê¸´ ì—¬í–‰ì„ ë– ë‚©ë‹ˆë‹¤. ì•„ë¹ ëŠ” ì•Œì„ ë°œ ìœ„ì— ì˜¬ë ¤ë†“ìŠµë‹ˆë‹¤. ê·¸ëŠ” íŠ¹ë³„í•œ í”¼ë¶€ ì£¼ë¦„ìœ¼ë¡œ ì•Œì„ ë®ìŠµë‹ˆë‹¤. ì´ê²ƒì„ 'ìœ¡ì•„ë‚­(brood pouch)'ì´ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤. ì•„ë¹ ëŠ” ë§¤ìš° ì¡°ì‹¬í•´ì•¼ í•©ë‹ˆë‹¤. ì•Œì´ ì–¼ìŒ ë•…ì— ë‹¿ìœ¼ë©´ ëª‡ ë¶„ ì•ˆì— ì–¼ì–´ë²„ë¦´ ê²ƒì…ë‹ˆë‹¤.<br><br>
            ì•„ë¹ ëŠ” ì•Œì´ ë¶€í™”í•  ë•Œê¹Œì§€ ë‘ ë‹¬ ë™ì•ˆ ì–¼ì–´ë¶™ì„ ë“¯í•œ ì¶”ìœ„ ì†ì—ì„œ ê°€ë§Œíˆ ì„œ ìˆìŠµë‹ˆë‹¤. ì•Œì€ ìœ¡ì•„ë‚­ ì•ˆì—ì„œ ì•½ 38ë„(Â°C)ë¡œ ë”°ëœ»í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤. ë‚¨ê·¹ì˜ ì™¸ë¶€ ì˜¨ë„ëŠ” ì˜í•˜ 35ë„(âˆ’35 Â°C) ì•„ë˜ë¡œ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¶”ìœ„ë¥¼ ê²¬ë””ê¸° ìœ„í•´, ì•„ë¹ ë“¤ì€ ê½‰ ë­‰ì³ì„œ "í—ˆë“¤(huddle)"ì„ ë§Œë“¤ê³  ì²´ì˜¨ì„ ë‚˜ëˆ•ë‹ˆë‹¤. ì´ ê¸°ê°„ ë™ì•ˆ, ì•„ë¹ ëŠ” ì•„ë¬´ê²ƒë„ ë¨¹ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ëŠ” ì‚´ì•„ë‚¨ê¸° ìœ„í•´ ì²´ì§€ë°©ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.<br><br>
            ë§ˆì¹¨ë‚´, ì•Œì´ ë¶€í™”í•©ë‹ˆë‹¤. ì—„ë§ˆëŠ” ìƒˆë¼ë¥¼ ìœ„í•œ ë¨¹ì´ë¥¼ ê°€ì§€ê³  ëŒì•„ì˜µë‹ˆë‹¤. ìƒˆë¼ëŠ” ë§¤ìš° ì‘ìŠµë‹ˆë‹¤. ë¬´ê²ŒëŠ” ê²¨ìš° 150gì—ì„œ 200g ì •ë„ì…ë‹ˆë‹¤. ë¶€ëª¨ëŠ” ìƒˆë¼ê°€ ë…ë¦½í•  ìˆ˜ ìˆì„ ë§Œí¼ í´ ë•Œê¹Œì§€ ë²ˆê°ˆì•„ ê°€ë©° ë¨¹ì´ë¥¼ ì£¼ê³  ëŒë´…ë‹ˆë‹¤.
        </div>
    </div>

    <!-- RIGHT: INTERACTION -->
    <div id="interaction-panel">
        <div id="setup-bar">
            <!-- No input field needed, direct start -->
            <button id="ready-btn">Start Survival Game</button>
        </div>

        <!-- NEW: Game HUD (Hidden initially) -->
        <div id="game-hud" style="display:none;">
            <div class="hud-item"><i class="fas fa-flag"></i> Stage: <span id="stage-val" class="hud-value">Start</span></div>
            <div class="hud-item"><i class="fas fa-egg"></i> Egg: <span id="egg-val" class="hud-value">Safe</span></div>
        </div>

        <!-- AI Interface (Hidden initially) -->
        <div id="ai-interface">
            <div id="ai-visual-container">
                <div id="ai-avatar"><i class="fas fa-egg"></i></div> <!-- EGG Icon for Survival -->
                <div class="ring"></div>
            </div>

            <div class="bubble-box">
                <div id="ai-text">...</div>
                
                <div id="ai-kor-hint"></div>
                <button id="hint-btn" class="hint-toggle-small hidden">
                    <i class="fas fa-language"></i> í•œê¸€ ë³´ê¸°
                </button>
            </div>

            <div id="user-stt-display"></div>

            <button id="mic-btn" disabled><i class="fas fa-microphone"></i></button>
            <button id="next-btn" class="hidden">Next Activity &rarr;</button> <!-- Next Button Added -->
            
            <div class="status-text" id="status-text">Ready</div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        let messages = [];
        let recognition;
        let isRecogActive = false;
        let isAIProcessing = false;

        // --- DOM Elements ---
        const ui = {
            splashScreen: document.getElementById('splash-screen'),
            enterBtn: document.getElementById('enter-btn'),
            setupBar: document.getElementById('setup-bar'),
            readyBtn: document.getElementById('ready-btn'),
            interactionPanel: document.getElementById('interaction-panel'),
            aiInterface: document.getElementById('ai-interface'),
            gameHud: document.getElementById('game-hud'),
            stageVal: document.getElementById('stage-val'),
            eggVal: document.getElementById('egg-val'),
            aiText: document.getElementById('ai-text'),
            aiKorHint: document.getElementById('ai-kor-hint'),
            hintBtn: document.getElementById('hint-btn'),
            micBtn: document.getElementById('mic-btn'),
            nextBtn: document.getElementById('next-btn'),
            sttDisplay: document.getElementById('user-stt-display'),
            statusText: document.getElementById('status-text'),
            avatar: document.getElementById('ai-avatar'),
            toggleKorBtn: document.getElementById('toggle-kor-btn'),
            koreanTrans: document.getElementById('korean-trans')
        };

        // --- System Prompt for Cinematic Survival ---
        const SURVIVAL_PROMPT = `
You are the Narrator of a "Super Dad Survival" adventure.
Role: Narrator (Dramatic, Cinematic, Friendly).
User: Father Emperor Penguin.

SCENARIO FLOW:
1. **Intro**: "The wind howls at -30Â°C. *Whoosh!* You are a Father Penguin alone in the cold.\n\nThe mother passes you the precious egg.\n\n**Do you catch it with your BEAK or your FEET?**"
2. **Crisis 1 (The Drop)**:
   - If User says "Feet" (or similar): "[STAGE: 1/3] Safe! Phew. You cover it with your brood pouch.\n\nNow, a blizzard is coming! **Do you stand ALONE or join the HUDDLE?**"
   - If User says "Beak" or "Ice": "OH NO! The ice is too cold! [HIGHLIGHT: s11] Look at the highlighted text. The egg freezes in minutes on ice. Try again!"

3. **Crisis 2 (The Blizzard)**: 
   - If User says "Huddle": "[STAGE: 2/3] Smart choice! You share body heat with other dads. But... it has been 2 months. You are starving.\n\n**Do you LEAVE to find fish or WAIT?**"
   - If User says "Alone": "You are freezing... You turn into an ice statue. [HIGHLIGHT: s15] Look at the highlighted text. Fathers must form a huddle to endure the cold. Try again!"

4. **Crisis 3 (The Hunger)**: 
   - If User says "Wait" or "Body fat": "[STAGE: 3/3] You use your body fat to survive. You are weak but the egg is safe!" -> Move to Ending.
   - If User says "Fish" or "Leave": "You leave the egg? Oh no! The baby has no warmth. [HIGHLIGHT: s16] Look at the highlighted text. The father doesn't eat anything. Try again!"

5. **Ending**: "[ENDING] Crack! The egg hatches! The mother returns with food. You did it, Super Dad! You saved the baby. Congratulations!"

CRITICAL RULES:
1. Speak ENGLISH ONLY in the main text.
2. Be dramatic with sound effects (e.g., *Crack!*, *Whoosh!*).
3. **WRONG ANSWER**: Do NOT give the answer directly. Use [HIGHLIGHT: s#] to point to evidence and ask to try again.
4. **CORRECT ANSWER**: Praise the user and move to next stage.
5. Do NOT use markdown bolding (**).

OUTPUT FORMAT: ENGLISH_TEXT /// KOREAN_TRANSLATION
`;

        // --- 1. Event Listeners ---

        // Splash Screen Interaction
        ui.enterBtn.addEventListener('click', () => {
            ui.splashScreen.style.opacity = '0';
            setTimeout(() => {
                ui.splashScreen.style.display = 'none';
            }, 600);
        });

        // Toggle Korean Passage Translation
        ui.toggleKorBtn.addEventListener('click', () => {
            const isHidden = ui.koreanTrans.style.display !== 'block';
            ui.koreanTrans.style.display = isHidden ? 'block' : 'none';
            ui.toggleKorBtn.textContent = isHidden ? 'í•œê¸€ í•´ì„ ìˆ¨ê¸°ê¸°' : 'í•œê¸€ í•´ì„ ë³´ê¸°';
            ui.toggleKorBtn.classList.toggle('active', isHidden);
            if(isHidden) setTimeout(() => ui.koreanTrans.scrollIntoView({behavior: "smooth"}), 100);
        });

        // Toggle AI Korean Hint Bubble
        ui.hintBtn.addEventListener('click', () => {
            const isHidden = ui.aiKorHint.style.display !== 'block';
            ui.aiKorHint.style.display = isHidden ? 'block' : 'none';
            ui.hintBtn.innerHTML = isHidden ? '<i class="fas fa-eye-slash"></i> í•œê¸€ ìˆ¨ê¸°ê¸°' : '<i class="fas fa-language"></i> í•œê¸€ ë³´ê¸°';
        });

        // Login / Ready Button -> DIRECT START SURVIVAL
        ui.readyBtn.addEventListener('click', () => {
            ui.setupBar.classList.add('hidden');
            startSurvivalGame();
        });

        // Start Survival Game
        function startSurvivalGame() {
            ui.interactionPanel.classList.add('game-mode'); // Dark Theme
            ui.gameHud.style.display = 'flex'; // Show HUD
            ui.aiInterface.style.display = 'flex'; // Show AI Interface
            ui.avatar.classList.add('survival-mode'); // Add game styling
            
            initSpeechRecognition();
            
            messages = [{ role: "system", content: SURVIVAL_PROMPT }]; 
            processAI(); // Start conversation
        }

        // Mic Toggle
        ui.micBtn.addEventListener('click', () => {
            if(isAIProcessing) return;
            if(isRecogActive) recognition.stop();
            else recognition.start();
        });
        
        // Next Button (Restart or Next Activity Placeholder)
        ui.nextBtn.addEventListener('click', () => {
            alert("Great job! Moving to the next activity...");
            location.reload();
        });

        // --- 2. Logic Functions ---

        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("This browser does not support Speech Recognition. Please use Chrome or Edge.");
                return;
            }
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.continuous = false;

            recognition.onstart = () => {
                isRecogActive = true;
                ui.micBtn.classList.add('active');
                ui.statusText.textContent = "Listening...";
                ui.sttDisplay.textContent = "...";
            };

            recognition.onresult = (event) => {
                const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
                ui.sttDisplay.textContent = transcript;
            };

            recognition.onend = () => {
                isRecogActive = false;
                ui.micBtn.classList.remove('active');
                const text = ui.sttDisplay.textContent;
                
                if (text && text !== "..." && !isAIProcessing) {
                    handleUserAudio(text);
                } else {
                    ui.statusText.textContent = "Click mic to speak";
                }
            };
            
            // Error Handling for STT
            recognition.onerror = (event) => {
                console.error("Speech recognition error", event.error);
                ui.statusText.textContent = "Error: " + event.error;
                ui.micBtn.classList.remove('active');
                isRecogActive = false;
            };
        }

        async function handleUserAudio(text) {
            isAIProcessing = true;
            ui.micBtn.disabled = true;
            ui.statusText.textContent = "Thinking...";
            ui.avatar.classList.add('thinking');
            
            messages.push({ role: "user", content: text });
            await processAI();
        }

        async function processAI() {
            try {
                // 1. Text Request (Using Netlify Function Proxy)
                // Always use the proxy since the key is in the server environment
                const resp = await fetch('/.netlify/functions/openai_proxy', {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'chat',
                        messages: messages
                    })
                });
                
                if (!resp.ok) {
                    throw new Error(`Server Error: ${resp.status}`);
                }
                
                const data = await resp.json();
                if(data.error) throw new Error(data.error.message);

                const content = data.choices[0].message.content;
                messages.push({ role: "assistant", content: content });

                // Parse Content
                let [engText, korText] = content.split('///');
                engText = engText ? engText.trim() : "";
                korText = korText ? korText.trim() : "";

                // Highlights & Game Over Logic
                const hMatch = engText.match(/\[HIGHLIGHT:\s*(s\d+)\]/);
                if(hMatch) {
                    highlightSentence(hMatch[1]);
                    // Wrong Answer (Crisis) Animation
                    ui.avatar.classList.add('danger');
                    ui.eggVal.textContent = "DANGER!";
                    ui.eggVal.style.color = "#ff7675";
                    setTimeout(() => ui.avatar.classList.remove('danger'), 1000);
                    engText = engText.replace(/\[HIGHLIGHT:\s*s\d+\]/, '');
                } else {
                    clearHighlights();
                }
                
                // Stage Extraction (Success)
                const sMatch = engText.match(/\[STAGE:\s*([^\]]+)\]/);
                if(sMatch) {
                    ui.stageVal.textContent = sMatch[1];
                    engText = engText.replace(/\[STAGE:\s*[^\]]+\]/, '');
                    
                    // Safe Animation
                    ui.avatar.classList.add('safe');
                    ui.eggVal.textContent = "Safe";
                    ui.eggVal.style.color = "#55efc4";
                    setTimeout(() => ui.avatar.classList.remove('safe'), 2000);
                }

                // Ending Hatching Animation
                if(engText.includes("[ENDING]")) {
                    ui.avatar.classList.add('hatching');
                    // Penguin Emoji for the hatching animation
                    ui.avatar.innerHTML = '<span style="font-size: 80px;">ğŸ§</span>'; 
                    engText = engText.replace("[ENDING]", "");
                    ui.eggVal.textContent = "HATCHED!";
                    ui.eggVal.style.color = "#55efc4";
                    
                    // Hide Mic, Show Next Button
                    ui.micBtn.classList.add('hidden');
                    ui.statusText.style.display = 'none';
                    ui.nextBtn.classList.remove('hidden');
                }

                // Clean Text (Ensure English Only for TTS/Display)
                const cleanEngText = engText.replace(/[ê°€-í£]/g, "").trim();

                // UI Update: Show loading initially
                ui.aiText.textContent = "..."; 
                ui.aiKorHint.textContent = korText;
                ui.aiKorHint.style.display = 'none';
                ui.hintBtn.classList.remove('hidden');
                ui.hintBtn.innerHTML = '<i class="fas fa-language"></i> í•œê¸€ ë³´ê¸°';
                
                ui.avatar.classList.remove('thinking');
                ui.statusText.textContent = "Preparing voice...";

                // 2. Audio Generation (TTS via Proxy)
                const ttsResp = await fetch('/.netlify/functions/openai_proxy', {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'tts',
                        input: cleanEngText
                    })
                });
                
                if (!ttsResp.ok) throw new Error("TTS Error");
                
                const blob = await ttsResp.blob();
                const audio = new Audio(URL.createObjectURL(blob));

                // Play & Sync
                ui.statusText.textContent = "Speaking...";
                ui.avatar.classList.add('speaking');
                
                audio.play().then(() => {
                    // Typewriter effect starts only when audio plays
                    typeWriter(cleanEngText, ui.aiText);
                }).catch(e => console.error(e));

                audio.onended = () => {
                    ui.avatar.classList.remove('speaking');
                    if (!ui.nextBtn.classList.contains('hidden')) {
                         ui.statusText.textContent = "Activity Complete";
                    } else {
                         ui.statusText.textContent = "Click mic to reply";
                         ui.micBtn.disabled = false;
                    }
                    isAIProcessing = false;
                };

            } catch (error) {
                console.error(error);
                ui.aiText.textContent = "Error: " + error.message;
                ui.avatar.classList.remove('thinking');
                ui.micBtn.disabled = false;
                isAIProcessing = false;
            }
        }

        // --- 3. Helper Functions ---

        function highlightSentence(id) {
            clearHighlights();
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('highlight');
                el.scrollIntoView({behavior:'smooth', block:'center'});
            }
        }

        function clearHighlights() {
            document.querySelectorAll('.sent').forEach(el => el.classList.remove('highlight'));
        }

        function typeWriter(text, element) {
            element.innerHTML = ''; // Clear previous content
            let i = 0;
            const speed = 40; 
            
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

    </script>
</body>
</html>
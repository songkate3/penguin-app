<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Reading Coach: Emperor Penguins</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* (Í∏∞Ï°¥ Ïä§ÌÉÄÏùºÍ≥º ÎèôÏùº, ÏùºÎ∂Ä Í≤åÏûÑ Î™®Îìú Ïä§ÌÉÄÏùº Ïú†ÏßÄ) */
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fdcb6e;
            --bg-color: #dfe6e9;
            --panel-bg: #ffffff;
            --text-color: #2d3436;
            --highlight: #ffeaa7;
            --game-btn: #00cec9;
            --game-bg: #2c3e50;
            --danger: #ff7675;
            --safe: #55efc4;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; }
        
        /* Layout */
        #reading-panel { width: 45%; padding: 40px; background-color: var(--panel-bg); border-right: 1px solid #b2bec3; overflow-y: auto; display: flex; flex-direction: column; }
        #interaction-panel { width: 55%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #f5f6fa 0%, #dcdde1 100%); position: relative; transition: background 0.5s; }
        #interaction-panel.game-mode { background: linear-gradient(135deg, #2c3e50 0%, #000000 100%); color: white; }

        /* Reading Panel Elements */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f1f2f6; }
        h2 { margin: 0; color: var(--primary); font-size: 1.8rem; }
        .passage-content { font-size: 1.2rem; line-height: 1.9; color: #444; text-align: justify; }
        .toggle-btn { background: white; border: 2px solid var(--primary); color: var(--primary); padding: 6px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.85rem; transition: 0.3s; }
        .toggle-btn.active { background: var(--primary); color: white; }
        #korean-trans { display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; font-size: 1rem; color: #636e72; line-height: 1.6; border-left: 4px solid var(--primary); }
        .sent { border-radius: 4px; padding: 2px 0; transition: background-color 0.5s ease; }
        .sent.highlight { background-color: var(--highlight); box-shadow: 0 0 8px rgba(253, 203, 110, 0.6); font-weight: 700; border-bottom: 2px solid var(--accent); }

        /* Intro Splash */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #6c5ce7, #a29bfe); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.6s ease-out; }
        .splash-content { text-align: center; color: white; animation: zoomIn 0.8s; }
        .splash-title { font-size: 3.5rem; font-weight: 800; margin-bottom: 10px; text-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .splash-subtitle { font-size: 1.5rem; opacity: 0.9; margin-bottom: 40px; }
        .splash-icon { font-size: 6rem; margin-bottom: 30px; display: inline-block; animation: bounce 2s infinite; }
        #enter-btn { padding: 15px 50px; font-size: 1.3rem; border: none; border-radius: 50px; background: white; color: var(--primary); font-weight: bold; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: transform 0.2s; }
        #enter-btn:hover { transform: translateY(-3px); }

        /* Game HUD & UI */
        #setup-bar { position: absolute; top: 20px; background: rgba(255, 255, 255, 0.95); padding: 10px 20px; border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; gap: 10px; z-index: 100; transition: opacity 0.5s; }
        #api-key-input { border: 1px solid #dfe6e9; padding: 10px 15px; border-radius: 20px; outline: none; width: 220px; font-family: monospace; }
        #ready-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        
        #game-hud { display: none; width: 90%; justify-content: space-between; margin-bottom: 20px; background: rgba(255, 255, 255, 0.1); padding: 10px 20px; border-radius: 15px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); animation: slideDown 0.5s; }
        .hud-item { font-size: 1.1rem; font-weight: bold; color: #fab1a0; }
        .hud-value { color: white; margin-left: 5px; }

        /* AI Visuals */
        #ai-interface { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        #ai-visual-container { position: relative; width: 160px; height: 160px; margin-bottom: 20px; }
        #ai-avatar { width: 100%; height: 100%; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 100px; box-shadow: 0 10px 30px rgba(108, 92, 231, 0.2); transition: all 0.3s; position: relative; z-index: 2; }
        
        #ai-avatar.survival-mode { background: #34495e; color: white; border: 5px solid var(--game-btn); }
        #ai-avatar.survival-mode.danger { color: var(--danger); border-color: var(--danger); animation: eggCrack 0.5s ease-in-out; }
        #ai-avatar.survival-mode.safe { color: var(--safe); border-color: var(--safe); box-shadow: 0 0 40px var(--safe); animation: eggGlow 1.5s infinite alternate; }
        #ai-avatar.survival-mode.hatching { border: 5px solid var(--safe); background-color: #e3fdf5; color: #2d3436; animation: hatchPop 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55); }

        .ring { position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 50%; border: 3px solid transparent; z-index: 1; }
        #ai-avatar.speaking + .ring { border-color: var(--accent); animation: pulse-ring 1.5s infinite; }
        #ai-avatar.thinking { border: 3px solid #b2bec3; animation: pulse-gray 1.5s infinite; }

        /* Bubble & Text */
        .bubble-box { width: 85%; max-width: 600px; background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); min-height: 120px; display: flex; flex-direction: column; justify-content: center; text-align: center; position: relative; margin-bottom: 20px; }
        .game-mode .bubble-box { background: rgba(255, 255, 255, 0.9); border: 2px solid var(--game-btn); }
        #ai-text { font-size: 1.35rem; color: #2d3436; font-weight: 600; line-height: 1.4; margin-bottom: 10px; white-space: pre-line; }
        #ai-kor-hint { font-size: 1.1rem; color: #636e72; display: none; border-top: 1px dashed #dfe6e9; padding-top: 15px; margin-top: 10px; }
        .hint-toggle-small { position: absolute; bottom: 10px; right: 20px; font-size: 0.8rem; color: #b2bec3; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* Mic & Controls */
        #user-stt-display { height: 30px; width: 80%; text-align: center; color: var(--primary); font-weight: bold; font-size: 1.1rem; margin-bottom: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .game-mode #user-stt-display { color: #fab1a0; }
        #mic-btn { width: 80px; height: 80px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 30px; cursor: pointer; box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4); transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        #mic-btn:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; }
        #mic-btn.active { background: #ff7675; animation: bounce 1s infinite; }
        #next-btn { padding: 15px 40px; font-size: 1.2rem; border: none; border-radius: 50px; background: var(--safe); color: #2d3436; font-weight: bold; cursor: pointer; box-shadow: 0 10px 20px rgba(85, 239, 196, 0.4); animation: bounce 2s infinite; }
        
        /* Animations */
        @keyframes bounce { 0%, 100% {transform: scale(1);} 50% {transform: scale(1.1);} }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes eggCrack { 0% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } 100% { transform: rotate(0deg); } }
        @keyframes eggGlow { from { box-shadow: 0 0 10px var(--safe); transform: scale(1); } to { box-shadow: 0 0 40px var(--safe); transform: scale(1.05); } }
        @keyframes hatchPop { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse-ring { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }
        @keyframes pulse-gray { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        .status-text { margin-top: 15px; color: #636e72; font-size: 0.9rem; }
        .game-mode .status-text { color: #bdc3c7; }

        @media (max-width: 768px) {
            body { flex-direction: column; height: 100vh; }
            #reading-panel { width: 100%; height: 40%; padding: 20px; border-right: none; border-bottom: 1px solid #ccc; }
            #interaction-panel { width: 100%; height: 60%; }
            #ai-avatar { font-size: 40px; }
            #mic-btn { width: 60px; height: 60px; font-size: 24px; }
        }
    </style>
</head>
<body>
    <!-- Splash -->
    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-icon">üêß</div>
            <div class="splash-title">AI post-reading activity</div>
            <div class="splash-subtitle">Emperor Penguin Survival Challenge</div>
            <button id="enter-btn">Let's Start!</button>
        </div>
    </div>

    <!-- Left: Reading -->
    <div id="reading-panel">
        <div class="header-row">
            <h2>Emperor Penguins</h2>
            <button id="toggle-kor-btn" class="toggle-btn">ÌïúÍ∏Ä Ìï¥ÏÑù Î≥¥Í∏∞</button>
        </div>
        <div class="passage-content">
            <span id="s1" class="sent">Emperor penguins are the world‚Äôs largest penguins.</span>
            <span id="s2" class="sent">Adult emperor penguins can stand over 1 meter tall.</span>
            <span id="s3" class="sent">But to grow this tall from an egg, Emperor Penguins need a lot of dedicated work from their parents.</span>
            <br><br>
            <span id="s4" class="sent">Every winter, each mother penguin lays just one egg.</span>
            <span id="s5" class="sent">The mother passes the egg to the father.</span>
            <span id="s6" class="sent">Then she goes on a long journey to the ocean to find food.</span>
            <span id="s7" class="sent">The father puts the egg on his feet.</span>
            <span id="s8" class="sent">He covers it with a special skin fold.</span>
            <span id="s9" class="sent">This is called a brood pouch.</span>
            <span id="s10" class="sent">He has to be very careful.</span>
            <span id="s11" class="sent">The egg will freeze within minutes if it touches the icy ground.</span>
            <br><br>
            <span id="s12" class="sent">The father stands still in the freezing cold for two months until the egg hatches.</span>
            <span id="s13" class="sent">The egg is kept warm in the brood pouch at about 38 ¬∞C.</span>
            <span id="s14" class="sent">Outside temperatures in Antarctica can drop below ‚àí35 ¬∞C.</span>
            <span id="s15" class="sent">To endure the cold, fathers form a tight "huddle" and share their body heat.</span>
            <span id="s16" class="sent">During this time, the father doesn‚Äôt eat anything.</span>
            <span id="s17" class="sent">He uses his body fat to survive.</span>
            <br><br>
            <span id="s18" class="sent">Finally, the egg hatches.</span>
            <span id="s19" class="sent">The mother returns with food for the chick.</span>
            <span id="s20" class="sent">The chick is very small.</span>
            <span id="s21" class="sent">It weighs only about 150 g to 200 g.</span>
            <span id="s22" class="sent">The parents take turns feeding and caring for their chick until it‚Äôs big enough to be independent.</span>
        </div>
        <div id="korean-trans">
            (Ï†ÑÏ≤¥ Ìï¥ÏÑù ÎÇ¥Ïö© ÏÉùÎûµ - Í∏∞Ï°¥Í≥º ÎèôÏùº)
        </div>
    </div>

    <!-- Right: Interaction -->
    <div id="interaction-panel">
        <div id="setup-bar">
            <input type="password" id="api-key-input" placeholder="OpenAI API Key (Leave empty to use Server)" />
            <button id="ready-btn">Login & Start</button>
        </div>

        <div id="game-hud" style="display:none;">
            <div class="hud-item"><i class="fas fa-flag"></i> Stage: <span id="stage-val" class="hud-value">Start</span></div>
            <div class="hud-item"><i class="fas fa-egg"></i> Egg: <span id="egg-val" class="hud-value">Safe</span></div>
        </div>

        <div id="ai-interface">
            <div id="ai-visual-container">
                <div id="ai-avatar"><i class="fas fa-egg"></i></div>
                <div class="ring"></div>
            </div>
            <div class="bubble-box">
                <div id="ai-text">...</div>
                <div id="ai-kor-hint"></div>
                <button id="hint-btn" class="hint-toggle-small hidden"><i class="fas fa-language"></i> ÌïúÍ∏Ä Î≥¥Í∏∞</button>
            </div>
            <div id="user-stt-display"></div>
            <button id="mic-btn" disabled><i class="fas fa-microphone"></i></button>
            <button id="next-btn" class="hidden">Next Activity &rarr;</button>
            <div class="status-text" id="status-text">Ready</div>
        </div>
    </div>

    <script>
        let apiKey = '';
        let messages = [];
        let recognition;
        let isRecogActive = false;
        let isAIProcessing = false;
        let useProxy = false; // ÏÑúÎ≤Ñ ÏÇ¨Ïö© Î™®Îìú

        const ui = {
            splash: document.getElementById('splash-screen'),
            enter: document.getElementById('enter-btn'),
            setupBar: document.getElementById('setup-bar'),
            apiKeyInput: document.getElementById('api-key-input'),
            readyBtn: document.getElementById('ready-btn'),
            panel: document.getElementById('interaction-panel'),
            interface: document.getElementById('ai-interface'),
            hud: document.getElementById('game-hud'),
            stage: document.getElementById('stage-val'),
            egg: document.getElementById('egg-val'),
            aiText: document.getElementById('ai-text'),
            aiHint: document.getElementById('ai-kor-hint'),
            hintBtn: document.getElementById('hint-btn'),
            mic: document.getElementById('mic-btn'),
            nextBtn: document.getElementById('next-btn'),
            stt: document.getElementById('user-stt-display'),
            status: document.getElementById('status-text'),
            avatar: document.getElementById('ai-avatar'),
            toggleKor: document.getElementById('toggle-kor-btn'),
            korTrans: document.getElementById('korean-trans')
        };

        const SURVIVAL_PROMPT = `
You are the Narrator of a "Super Dad Survival" adventure.
Role: Narrator (Dramatic, Cinematic, Friendly).
User: Father Emperor Penguin.

SCENARIO FLOW:
1. **Intro**: "You are a Father Penguin alone in the cold. The mother passes you the egg.\n\nDo you catch it with your BEAK or your FEET?"
2. **Crisis 1 (The Drop)**:
   - If User says "Feet": "[STAGE: 1/3] Safe! Phew. You cover it with your brood pouch.\n\nNow, a blizzard is coming! Do you stand ALONE or join the HUDDLE?"
   - If User says "Beak" or "Ice": "OH NO! The ice is too cold! [HIGHLIGHT: s11] Look at the highlighted text. The egg freezes in minutes on ice. Try again!"
3. **Crisis 2 (The Blizzard)**: 
   - If User says "Huddle": "[STAGE: 2/3] Smart choice! You share body heat with other dads. But... it has been 2 months. You are starving.\n\nDo you LEAVE to find fish or WAIT?"
   - If User says "Alone": "You are freezing... You turn into an ice statue. [HIGHLIGHT: s15] Look at the highlighted text. Fathers must form a huddle to endure the cold. Try again!"
4. **Crisis 3 (The Hunger)**: 
   - If User says "Wait" or "Body fat": "[STAGE: 3/3] You use your body fat to survive. You are weak but the egg is safe!" -> Move to Ending.
   - If User says "Fish" or "Leave": "You leave the egg? Oh no! The baby has no warmth. [HIGHLIGHT: s16] Look at the highlighted text. The father doesn't eat anything. Try again!"
5. **Ending**: "[ENDING] Crack! The egg hatches! The mother returns with food. You did it, Super Dad! You saved the baby. Congratulations!"

CRITICAL RULES:
1. Speak ENGLISH ONLY in the main text.
2. **WRONG ANSWER**: Do NOT give the answer directly. Use [HIGHLIGHT: s#] to point to evidence and ask to try again.
3. **CORRECT ANSWER**: Praise the user and move to next stage.
4. Do NOT use markdown bolding (**).

OUTPUT FORMAT: ENGLISH_TEXT /// KOREAN_TRANSLATION
`;

        // --- Event Listeners ---
        ui.enter.addEventListener('click', () => { ui.splash.style.opacity = '0'; setTimeout(() => ui.splash.style.display = 'none', 600); });
        
        ui.toggleKor.addEventListener('click', () => {
            const isHidden = ui.korTrans.style.display !== 'block';
            ui.korTrans.style.display = isHidden ? 'block' : 'none';
            ui.toggleKor.textContent = isHidden ? 'ÌïúÍ∏Ä Ìï¥ÏÑù Ïà®Í∏∞Í∏∞' : 'ÌïúÍ∏Ä Ìï¥ÏÑù Î≥¥Í∏∞';
            ui.toggleKor.classList.toggle('active', isHidden);
            if(isHidden) setTimeout(() => ui.korTrans.scrollIntoView({behavior:"smooth"}), 100);
        });

        ui.hintBtn.addEventListener('click', () => {
            const isHidden = ui.aiHint.style.display !== 'block';
            ui.aiHint.style.display = isHidden ? 'block' : 'none';
            ui.hintBtn.innerHTML = isHidden ? '<i class="fas fa-eye-slash"></i> ÌïúÍ∏Ä Ïà®Í∏∞Í∏∞' : '<i class="fas fa-language"></i> ÌïúÍ∏Ä Î≥¥Í∏∞';
        });

        ui.readyBtn.addEventListener('click', () => {
            const key = ui.apiKeyInput.value.trim();
            if (key.startsWith('sk-')) {
                apiKey = key;
                useProxy = false;
            } else if (key === "") {
                useProxy = true; // Use Netlify Function if empty
            } else {
                alert("Invalid Key. Enter a valid key or leave empty to use Server.");
                return;
            }
            
            ui.setupBar.classList.add('hidden');
            startSurvivalGame();
        });

        function startSurvivalGame() {
            ui.panel.classList.add('game-mode');
            ui.hud.style.display = 'flex';
            ui.interface.style.display = 'flex';
            ui.avatar.classList.add('survival-mode');
            
            initSpeech();
            messages = [{ role: "system", content: SURVIVAL_PROMPT }]; 
            processAI();
        }

        ui.mic.addEventListener('click', () => {
            if(isAIProcessing) return;
            if(isRecogActive) recognition.stop();
            else recognition.start();
        });

        ui.nextBtn.addEventListener('click', () => {
            alert("Activity Complete! Reloading for next student...");
            location.reload();
        });

        // --- Logic ---
        function initSpeech() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Please use Chrome browser."); return;
            }
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false; // Turn-based
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isRecogActive = true;
                ui.mic.classList.add('active');
                ui.status.textContent = "Listening...";
                ui.stt.textContent = "...";
            };

            recognition.onresult = (e) => {
                const txt = Array.from(e.results).map(r => r[0].transcript).join('');
                ui.stt.textContent = txt;
            };

            recognition.onend = () => {
                isRecogActive = false;
                ui.mic.classList.remove('active');
                const txt = ui.stt.textContent;
                if(txt && txt !== '...' && !isAIProcessing) {
                    handleUserAudio(txt);
                } else {
                    ui.status.textContent = "Click mic to speak";
                }
            };
            
            recognition.onerror = (e) => {
                console.error(e);
                ui.status.textContent = "Error. Try again.";
                ui.mic.classList.remove('active');
                isRecogActive = false;
            };
        }

        async function handleUserAudio(txt) {
            isAIProcessing = true;
            ui.mic.disabled = true;
            ui.status.textContent = "Thinking...";
            ui.avatar.classList.add('thinking');
            messages.push({ role: "user", content: txt });
            await processAI();
        }

        async function processAI() {
            try {
                let responseData;
                
                // 1. Text Request
                if (useProxy) {
                    const resp = await fetch('/.netlify/functions/openai_proxy', {
                        method: 'POST',
                        body: JSON.stringify({ type: 'chat', messages: messages })
                    });
                    if(!resp.ok) throw new Error("Server Error");
                    responseData = await resp.json();
                } else {
                    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({ model: "gpt-4o-mini", messages: messages, max_tokens: 200 })
                    });
                    responseData = await resp.json();
                }

                if(responseData.error) throw new Error(responseData.error.message);
                const content = responseData.choices[0].message.content;
                messages.push({ role: "assistant", content: content });

                // Parse
                let [engText, korText] = content.split('///');
                engText = engText ? engText.trim() : "";
                korText = korText ? korText.trim() : "";

                // Logic: Highlight & Animation
                const hMatch = engText.match(/\[HIGHLIGHT:\s*(s\d+)\]/);
                if(hMatch) {
                    highlightSentence(hMatch[1]);
                    // Danger
                    ui.avatar.classList.add('danger');
                    ui.egg.textContent = "DANGER!";
                    ui.egg.style.color = "#ff7675";
                    setTimeout(() => ui.avatar.classList.remove('danger'), 1000);
                    engText = engText.replace(/\[HIGHLIGHT:\s*s\d+\]/, '');
                } else {
                    clearHighlights();
                }

                const sMatch = engText.match(/\[STAGE:\s*([^\]]+)\]/);
                if(sMatch) {
                    ui.stage.textContent = sMatch[1];
                    engText = engText.replace(/\[STAGE:\s*[^\]]+\]/, '');
                    // Safe
                    ui.avatar.classList.add('safe');
                    ui.egg.textContent = "Safe";
                    ui.egg.style.color = "#55efc4";
                    setTimeout(() => ui.avatar.classList.remove('safe'), 2000);
                }

                if(engText.includes("[ENDING]")) {
                    ui.avatar.classList.add('hatching');
                    ui.avatar.innerHTML = '<span style="font-size: 80px;">üêß</span>';
                    engText = engText.replace("[ENDING]", "");
                    ui.egg.textContent = "HATCHED!";
                    ui.egg.style.color = "#55efc4";
                    
                    ui.mic.classList.add('hidden');
                    ui.status.style.display = 'none';
                    ui.nextBtn.classList.remove('hidden');
                }

                const cleanEngText = engText.replace(/[Í∞Ä-Ìû£]/g, "").trim();

                // UI Update
                ui.aiText.textContent = "...";
                ui.aiHint.textContent = korText;
                ui.aiHint.style.display = 'none';
                ui.hintBtn.classList.remove('hidden');
                ui.hintBtn.innerHTML = '<i class="fas fa-language"></i> ÌïúÍ∏Ä Î≥¥Í∏∞';
                ui.avatar.classList.remove('thinking');
                ui.status.textContent = "Preparing voice...";

                // 2. Audio Request
                let audioUrl;
                if (useProxy) {
                    const ttsResp = await fetch('/.netlify/functions/openai_proxy', {
                        method: 'POST',
                        body: JSON.stringify({ type: 'tts', input: cleanEngText })
                    });
                    const blob = await ttsResp.blob();
                    audioUrl = URL.createObjectURL(blob);
                } else {
                    const ttsResp = await fetch('https://api.openai.com/v1/audio/speech', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({ model: "tts-1", input: cleanEngText, voice: "nova", speed: 0.9 })
                    });
                    const blob = await ttsResp.blob();
                    audioUrl = URL.createObjectURL(blob);
                }

                // Play
                const audio = new Audio(audioUrl);
                ui.status.textContent = "Speaking...";
                ui.avatar.classList.add('speaking');
                
                audio.play().then(() => {
                    typeWriter(cleanEngText, ui.aiText);
                }).catch(console.error);

                audio.onended = () => {
                    ui.avatar.classList.remove('speaking');
                    if (!ui.nextBtn.classList.contains('hidden')) {
                         ui.status.textContent = "Activity Complete";
                    } else {
                         ui.status.textContent = "Click mic to reply";
                         ui.mic.disabled = false;
                    }
                    isAIProcessing = false;
                };

            } catch (e) {
                console.error(e);
                ui.aiText.textContent = "Error: " + e.message;
                ui.avatar.classList.remove('thinking');
                ui.mic.disabled = false;
                isAIProcessing = false;
            }
        }

        // Helpers
        function highlightSentence(id) {
            clearHighlights();
            const el = document.getElementById(id);
            if(el) { el.classList.add('highlight'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
        }
        function clearHighlights() { document.querySelectorAll('.sent').forEach(e => e.classList.remove('highlight')); }
        
        function typeWriter(text, el) {
            el.innerHTML = '';
            let i = 0;
            function type() {
                if (i < text.length) {
                    el.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, 40);
                }
            }
            type();
        }
    </script>
</body>
</html>